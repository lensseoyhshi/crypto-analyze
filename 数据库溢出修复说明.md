# 数据库字段溢出问题修复说明

## 问题描述

在运行过程中出现以下错误：

```
(pymysql.err.DataError) (1264, "Out of range value for column 'marketcap' at row 1")
(pymysql.err.DataError) (1264, "Out of range value for column 'quotePrice' at row 1")
```

## 原因分析

### MySQL 数据类型范围限制

- **FLOAT**: 单精度浮点数，范围 ±3.402823466E+38
- **DOUBLE**: 双精度浮点数，范围 ±1.7976931348623157E+308

加密货币的市值、交易量、价格等数值可能非常大或非常小，超出 FLOAT 的存储范围。

### 受影响的表和字段

| 表名 | 字段 | 原类型 | 新类型 | 说明 |
|-----|------|--------|--------|------|
| `birdeye_token_transactions` | `basePrice` | FLOAT | DOUBLE | 目标币单价 |
| | `quotePrice` | FLOAT | DOUBLE | 计价币单价 |
| | `pricePair` | FLOAT | DOUBLE | 兑换比率 |
| | `tokenPrice` | FLOAT | DOUBLE | Token价格 |
| `birdeye_token_trending` | `marketcap` | FLOAT | DOUBLE | 流通市值 |
| | `fdv` | FLOAT | DOUBLE | 完全稀释估值 |
| | `liquidity` | FLOAT | DOUBLE | 流动性 |
| | `volume_24h_usd` | FLOAT | DOUBLE | 24小时交易量 |
| `birdeye_new_listings` | `liquidity` | FLOAT | DOUBLE | 初始流动性 |
| `birdeye_token_overview` | `market_cap` | FLOAT | DOUBLE | 市值 |
| | `fdv` | FLOAT | DOUBLE | 完全稀释估值 |
| | `liquidity` | FLOAT | DOUBLE | 流动性 |
| | `v24h` | FLOAT | DOUBLE | 24小时交易量 |
| | `v24h_usd` | FLOAT | DOUBLE | 24小时交易量USD |

## 解决方案

采用**两层防护**策略：

### 1. 数据库层：修改字段类型（可选）

将容易溢出的字段从 `FLOAT` 改为 `DOUBLE`。

**执行迁移：**

```bash
# 运行数据库迁移
alembic upgrade head
```

**迁移文件位置：**
```
alembic/versions/0004_change_trending_float_to_double.py
```

### 2. 代码层：数据安全处理（已实现）

在保存数据前，使用 `safe_float()` 和 `safe_double()` 函数对数值进行检查和清理。

**实现位置：**
```python
# app/repositories/birdeye_repository.py

def safe_float(value, max_value=1e38):
    """安全处理 FLOAT 类型，超出范围返回 None"""
    if value is None:
        return None
    try:
        float_value = float(value)
        if not (-max_value <= float_value <= max_value):
            logger.warning(f"Value {value} exceeds max_value {max_value}")
            return None
        return float_value
    except (ValueError, TypeError, OverflowError):
        return None

def safe_double(value):
    """安全处理 DOUBLE 类型，使用更大的范围（1e308）"""
    return safe_float(value, max_value=1e308)
```

**应用范围：**
- `save_or_update_token_trending()` - 热门代币
- `save_or_update_token_transaction()` - 代币交易
- `save_token_overview()` - 代币概览
- `save_or_update_new_listing()` - 新币上线

## 修改后的效果

### 数据保护
- 超出范围的数值会被设置为 `None`，而不是导致程序崩溃
- 在日志中记录警告信息，便于追踪问题

### 示例

```python
# 原来会报错的代码
existing_trending.marketcap = trending.marketcap  # 可能溢出

# 修复后的代码
existing_trending.marketcap = safe_double(trending.marketcap)  # 安全处理
```

如果 `trending.marketcap` 的值超出范围，会自动设置为 `None`，并记录警告日志：

```
WARNING - Value 1.5e+400 exceeds max_value 1e+308, setting to None
```

## 验证方法

### 1. 检查日志

查看是否还有溢出错误：

```bash
tail -f logs/app.log | grep "Out of range"
```

应该不再出现 "Out of range value" 错误。

### 2. 检查数据库

查询是否有 NULL 值（被安全处理的超限数据）：

```sql
-- 检查 trending 表
SELECT COUNT(*) as null_count
FROM birdeye_token_trending
WHERE marketcap IS NULL OR fdv IS NULL;

-- 检查 transactions 表  
SELECT COUNT(*) as null_count
FROM birdeye_token_transactions
WHERE quotePrice IS NULL OR basePrice IS NULL;
```

### 3. 查看警告日志

查找被截断的数据：

```bash
grep "exceeds max_value" logs/app.log
```

## 注意事项

1. **数据丢失**：超出范围的数值会被设置为 `None`，这意味着极端数据会丢失
2. **业务影响**：如果业务逻辑依赖这些字段，需要添加 NULL 值检查
3. **迁移风险**：修改字段类型可能需要较长时间（取决于表大小）

## 迁移前后对比

### 迁移前
```sql
DESCRIBE birdeye_token_trending;
-- marketcap    | float    | YES  |     | NULL    |
```

### 迁移后
```sql
DESCRIBE birdeye_token_trending;
-- marketcap    | double   | YES  |     | NULL    |
```

## 回滚方案

如果需要回滚：

```bash
alembic downgrade -1
```

**注意**：回滚可能导致已经存储的大数值再次溢出！

## 总结

通过在代码层添加数据安全处理，即使不执行数据库迁移，也能避免溢出错误。这种双层防护确保了系统的稳定性和数据完整性。

**建议**：
- ✅ **代码层防护已生效**（已实现，立即生效）
- ⚠️ **数据库迁移可选**（可以稍后执行，不影响当前运行）

